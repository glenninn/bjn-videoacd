<html>
<head>
	<title>TeleVisit Status</title>
<script src='jquery.min.js'></script>
<script src='bootstrap/js/bootstrap.js' type="text/javascript"></script>
  <!-- Bootstrap core CSS -->
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="styles.css" rel="stylesheet">

<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

<script type="text/javascript">

// Time delay between API calls to update the display of the ACD Queue
var interval = 2000; // Queue update rate (millisec)

var callQ = [];		// our copy of the ACD queue


// Make AJAX call to retrieve from ACD the URL that will launch
// the user into the correct BlueJeans meeting
//
function launchVideo(theId){
  $.ajax( {
  url: "/select/"+theId,
  method: 'GET',
  contentType: 'application/json'
  }).done( (data) => {
    getQueue();
    $("#results").val( JSON.stringify(data,null,2) );
	console.log("** calling:  " + JSON.stringify(data,null,2));
	window.open(data,"_blank");
  }).fail( (error) => {
	$("#results").val( JSON.stringify(data,null,2) );
  });
}

function idToCaller(theId){
  var p = null;
  for(var i=0; i<callQ.length; i++){
     if(theId == callQ[i].id){
	   p = callQ[i];
	   break;
	   }
  }
  return p;
}

function takeCall(anId){
    var p = idToCaller(anId);
	if(p == null){
	  alert("Could not find that user record");
	  return;
	  }

    if (confirm("Join call from: " + p.name + "?")){
		 launchVideo(anId)
    }
}


function buildQueue(peeps){
  var s = "";
  
  callQ = peeps;	// save our copy
  
  peeps.forEach( (inQ,i)=> {
    var d = new Date( parseInt(inQ.requested) );
    s += '<div class="peep" onclick="takeCall(' + inQ.id +')">';
	s += '<div class="slot">' + (i+1) + ') </div>';
	s += '<div class="name">' + inQ.name + '</div>';
	s += '<div class="when">' + d.toLocaleTimeString() + '</div>';
	s += '</div>';
  });
  
  $("#peeps").html(s);
  $("#results").val( JSON.stringify(peeps,null,2) );
  $("title").text(peeps.length + " Appt's in Queue")
}


var timer = null;
var heartBeat = 0;	// heartbeat indicator

function getQueue(){
  if(timer) {
    clearTimeout(timer);
  }
  $("#heartBeat").text(heartBeat++);
  $.ajax( {
  url: "/queue",
  method: 'GET',
  contentType: 'application/json'
  }).done( (data) => {
    buildQueue(data);
  }).fail( (error) => {
	$("#results").val( JSON.stringify(data,null,2) );
  });
  timer = setTimeout( ()=>{ getQueue(); }, interval);
}

function onLoad(){
  getQueue();
}

function gotoAdd(){
 window.location = "/addme.html";
}

$(window).load(onLoad);

</script>
	
	
</head>
<body>
<h1>Agent Console - Video Appointments</h1>
	<p class="intro">This application provides an Automatic Call Distribution ("ACD") queueing for BlueJeans video sessions.  This program is provided as a Reference Design, <i>use at your own risk</i>.</p>
    <p class="intro">Realtime display of requests for a Video Session.  Click on an entry to launch a BlueJeans call with the requester</p>
    <h2>Appointment Queue</h2>
	<p class="intro">Click on name to start the Video Appointment</p>
	
	<div id="peeps" class="peepscrl">
	</div>
	
<div id="debug">
	<h4>Debugging Area</h4>
	
	<div class="btn-group" role="group" aria-label="...">
		<button type="button" class="btn btn-info" onclick="gotoAdd()">Make Appointment</button>

		<div class="btn-group" role="group">

			<div class="dropup">
			  <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
				Show Raw Data
				<span class="caret"></span>
			  </button>
			  <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
				<li><a href="#">
					<textarea id="results" rows="10" cols="64"></textarea>
				</a></li>
			  </ul>
			</div>
		</div>
	</div>
	<div>
	  <span>App Heartbeat: </span><span id="heartBeat"></span>
	</div>
	<div>
	  <span>(c)2018, BlueJeans.</span>
	</div>
	
</div>
</body>	
</html>